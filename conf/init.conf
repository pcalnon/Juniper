#!/usr/bin/env bash
#####################################################################################################################################################################################################
# Project:       Juniper
# Sub-Project:   JuniperCanopy
# Application:   juniper_canopy
# Purpose:       Monitoring and Diagnostic Frontend for Cascade Correlation Neural Network
#
# Author:        Paul Calnon
# Version:       0.1.4 (0.7.3)
# File Name:     init.conf
# File Path:     <Project>/<Sub-Project>/<Application>/conf/
#
# Date:          2025-11-10
# Last Modified: 2025-12-25
#
# License:       MIT License
# Copyright:     Copyright (c) 2024,2025,2026 Paul Calnon
#
# Description:
#    This Script serves as the initialization config file for the Juniper Project's juniper_canopy prototype
#    Warning:  This Script / Config file is sourced by the try.bash script
#
#####################################################################################################################################################################################################
# Notes:
#     Warning:  This Config file is sourced by the all Juniper Canopy util scripts including the try.bash and get_code_stats.bash scripts
#
#####################################################################################################################################################################################################
# References:
#
#####################################################################################################################################################################################################
# TODO :
#
#####################################################################################################################################################################################################
# COMPLETED:
#
#####################################################################################################################################################################################################


#####################################################################################################################################################################################################
# Define Top Level Constants for Script
#####################################################################################################################################################################################################
echo "init.conf: Define Top Level Constants for Script"
export TRUE="0"
export FALSE="1"

# export DEBUG="${TRUE}"
export DEBUG="${FALSE}"


#####################################################################################################################################################################################################
# Define Bash Source indices for calling script info
#####################################################################################################################################################################################################
echo "init.conf: Define Bash Source indices for calling script info"
export SCRIPT_NAME_ID="1"
export LINE_NO_ID="0"
export FUNC_NAME_ID="1"


#####################################################################################################################################################################################################
# Get Project Constants
#####################################################################################################################################################################################################
echo "init.conf: Get Project Constants"
export CONF_EXT="conf"
export LOGS_EXT="log"
export COMMON_FILE_ROOT="common"

#####################################################################################################################################################################################################
# Define Project Environment Constants
#####################################################################################################################################################################################################
echo "init.conf: Define Project Environment Constants"
# shellcheck disable=SC2155
export CURRENT_PATH="$(realpath "${BASH_SOURCE[0]}")"
echo "init.conf: CURRENT_PATH: ${CURRENT_PATH}"
# shellcheck disable=SC2155
export INIT_CONF_DIR="$(dirname "${CURRENT_PATH}")"
echo "init.conf: INIT_CONF_DIR: ${INIT_CONF_DIR}"
# shellcheck disable=SC2155
export PROJ_DIR="$(dirname "${INIT_CONF_DIR}")"
echo "init.conf: PROJ_DIR: ${PROJ_DIR}"
# shellcheck disable=SC2155
export APP_NAME="$(basename "${PROJ_DIR}")"
echo "init.conf: APP_NAME: ${APP_NAME}"


#####################################################################################################################################################################################################
# Define Minimal Logging env Constants needed to configure log_fatal function.
#####################################################################################################################################################################################################
echo "init.conf: Define Minimal Logging env Constants needed to configure log_fatal function."
export LOGS_DIR_NAME="${LOGS_EXT}s"
echo "init.conf: LOGS_DIR_NAME: ${LOGS_DIR_NAME}"
export LOGS_DIR="${PROJ_DIR}/${LOGS_DIR_NAME}"
echo "init.conf: LOGS_DIR: ${LOGS_DIR}"
export LOG_FILE_NAME="${APP_NAME}.${LOGS_EXT}"
echo "init.conf: LOG_FILE_NAME: ${LOG_FILE_NAME}"
export LOG_FILE="${LOGS_DIR}/${LOG_FILE_NAME}"
echo "init.conf: LOG_FILE: ${LOG_FILE}"


#####################################################################################################################################################################################################
# Compatible names for logging_functions helpers
#####################################################################################################################################################################################################
echo "init.conf: Compatible names for logging_functions helpers"
export LOG_EXT="${LOGS_EXT}"
echo "init.conf: LOG_EXT: ${LOG_EXT}"
export LOG_DIR_NAME="${LOGS_DIR_NAME}"
echo "init.conf: LOG_DIR_NAME: ${LOG_DIR_NAME}"
export LOG_DIR="${LOGS_DIR}"
echo "init.conf: LOG_DIR: ${LOG_DIR}"


#####################################################################################################################################################################################################
# Define Calling Script Logging Info
#####################################################################################################################################################################################################
echo "init.conf: Define Calling Script Logging Info"
echo "init.conf: Bash Source: \"${BASH_SOURCE}\""
echo "init.conf: Bash Source[0]: \"${BASH_SOURCE[0]}\""
echo "init.conf: Bash Source[1]: \"${BASH_SOURCE[1]}\""
echo "init.conf: Bash Source[*]: \"${BASH_SOURCE[*]}\""
echo "init.conf: Script Name ID: \"${SCRIPT_NAME_ID}\""
echo "init.conf: Script Name: \"${BASH_SOURCE[${SCRIPT_NAME_ID}]}\""
echo "init.conf: Script Path: \"\$(realpath \"${BASH_SOURCE[${SCRIPT_NAME_ID}]}\")\""

# if [[ "${BASH_SOURCE[${SCRIPT_NAME_ID}]}" == "" ]]; then
#     CALLING_SCRIPT="${BASH_SOURCE[${SCRIPT_NAME_ID}]}"
# else
#     CALLING_SCRIPT="${PARENT_PATH_PARAM}"
# fi

[[ "${BASH_SOURCE["${SCRIPT_NAME_ID}"]}" != "" ]] && CALLING_SCRIPT="${BASH_SOURCE[${SCRIPT_NAME_ID}]}" || CALLING_SCRIPT="${PARENT_PATH_PARAM}"    # \" Grrrrrr

# shellcheck disable=SC2155
export CALLING_SCRIPT_PATH="$(realpath "${CALLING_SCRIPT}")"
echo "init.conf: Calling script path: ${CALLING_SCRIPT_PATH}"
# shellcheck disable=SC2155
export CALLING_SCRIPT="$(basename "${CALLING_SCRIPT_PATH}")"
echo "init.conf: Calling script: ${CALLING_SCRIPT}"
# shellcheck disable=SC2155
export CALLING_LINE="${BASH_LINENO[${LINE_NO_ID}]}"
echo "init.conf: Calling line: ${CALLING_LINE}"
# shellcheck disable=SC2155
export CALLING_FUNC="${FUNCNAME[${FUNC_NAME_ID}]}"
echo "init.conf: Calling function: ${CALLING_FUNC}"


#####################################################################################################################################################################################################
# Define Fatal Error logging
#####################################################################################################################################################################################################
echo "init.conf: Define Fatal Error logging"
function log_fatal() {
    MESSAGE="$1"
    RESET="\033[0m" && COLOR_FATAL="\033[1;97;41m"
    printf "%b%-21s %-28s %-21s %-11s %s%b\n" "${COLOR_FATAL}" "($(date +%F_%T))" "${CALLING_SCRIPT}:${CALLING_LINE})" "${CALLING_FUNC}:" "[FATAL]" "${MESSAGE}" "${RESET}" | tee -a "${LOG_FILE}" >&2
    set -e; exit $(( FALSE ))
}
export -f log_fatal  # Critical Error Logging is defined from this point


#####################################################################################################################################################################################################
# Define Project Enviornment, Common Config file, Relative Path Constants
#####################################################################################################################################################################################################
echo "init.conf: Define Project Enviornment, Common Config file, Relative Path Constants"
export CONF_DIR_NAME="${CONF_EXT}"
echo "init.conf: CONF_DIR_NAME: ${CONF_DIR_NAME}"
export CONF_DIR="${PROJ_DIR}/${CONF_DIR_NAME}"
echo "init.conf: CONF_DIR: ${CONF_DIR}"
export COMMON_FILE_NAME="${COMMON_FILE_ROOT}.${CONF_EXT}"
echo "init.conf: COMMON_FILE_NAME: ${COMMON_FILE_NAME}"
export COMMON_FILE="${CONF_DIR}/${COMMON_FILE_NAME}"
echo "init.conf: COMMON_FILE: ${COMMON_FILE}"

export PARENT_PID="${PPID}"
echo "init.conf: PARENT_PID: ${PARENT_PID}"


#####################################################################################################################################################################################################
# Source and Validate the Common Config File
#####################################################################################################################################################################################################
echo "init.conf: Source and Validate the Common Config File"
[[ ! -f "${COMMON_FILE}" ]] && log_fatal "Common config file not found: ${COMMON_FILE}"
echo "init.conf: Common config file validated: ${COMMON_FILE}"

# shellcheck disable=SC1090
echo "init.conf: Calling ${COMMON_FILE}"
if [[ "${DEBUG}" == "${TRUE}" ]]; then
    echo "init.conf: Running Common File"
    echo "init.conf: bash ${COMMON_FILE}"
    bash "${COMMON_FILE}"
    SUCCESS="$?"
    log_debug "Evaluated common config file: ${COMMON_FILE}"
    log_debug "Common config file evaluated successfully with exit code: ${SUCCESS}"
else
    source "${COMMON_FILE}"
    SUCCESS="$?"
    log_debug "Sourced common config file: ${COMMON_FILE}"
    log_debug "Common config file sourced successfully with exit code: ${SUCCESS}"
fi

[[ "${SUCCESS}" != "${TRUE}" ]] && log_fatal "Failed to source common config file: ${COMMON_FILE}"

[[ "${DEBUG}" == "${TRUE}" ]] && exit $(( TRUE )) || return $(( TRUE ))
